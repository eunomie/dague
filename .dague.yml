go:
  image:
    goPackages:
      - mvdan.cc/gofumpt@latest

  fmt:
    formatter: gofumpt
    goimports:
      locals:
        - github.com/docker
        - github.com/eunomie/dague

  build:
    targets:
      - &dague-build
        name: local
        type: local
        path: ./cmd/docker-dague
        out: ./dist
        env:
          CGO_ENABLED: 0
          GIT_COMMIT: $ git describe --tags | cut -c 2-
        ldflags: -s -w -X 'github.com/eunomie/dague/internal.Version=${GIT_COMMIT:-dev}'
      - << : *dague-build
        name: cross
        type: cross
        platforms:
          - linux/amd64
          - linux/arm64
          - darwin/amd64
          - darwin/arm64
          - windows/amd64
          - windows/arm64

  exec:
    info:
      deps:
        - task goversion
      cmds: |
        uname -a > info.txt
        go version >> info.txt
      export:
        pattern: info.txt
        path: .

tasks:
  install:
    deps:
      - go:build local
    cmds: |
      mkdir -p ~/.docker/cli-plugins
      install dist/docker-dague ~/.docker/cli-plugins/docker-dague

  refresh:
    deps:
      - go:fmt
      - go:doc

  goversion:
    cmds: |
      go version

  info:
    deps:
      - go:exec info
    cmds: |
      uname -a
      cat info.txt
      rm -f info.txt
