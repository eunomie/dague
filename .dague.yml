go:
  image: golang:1.19.4-alpine3.17
  fmt:
    goimports:
      locals:
        - github.com/docker
        - github.com/eunomie/dague

  lint:
    golangci:
      image: golangci/golangci-lint:v1.50.1

  build:
    targets:
      - &dague-build
        name: local
        type: local
        path: ./cmd/docker-dague
        out: ./dist
        env:
          CGO_ENABLED: 0
          GIT_COMMIT: $ git describe --tags | cut -c 2-
        ldflags: -s -w -X 'github.com/eunomie/dague/internal.Version=${GIT_COMMIT:-dev}'
      - << : *dague-build
        name: cross
        type: cross
        platforms:
          - linux/amd64
          - linux/arm64
          - darwin/amd64
          - darwin/arm64
          - windows/amd64
          - windows/arm64

tasks:
  install:
    deps:
      - go:build local
    cmds: |
      mkdir -p ~/.docker/cli-plugins
      install dist/docker-dague ~/.docker/cli-plugins/docker-dague

  refresh:
    deps:
      - go:fmt
      - go:doc
